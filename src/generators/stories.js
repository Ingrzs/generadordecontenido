import { getAiInstance } from '../services/api.js';

export const initStoriesGenerator = () => {
    // --- Elements ---
    const topicInput = document.getElementById('st-topic');
    const modeSelector = document.getElementById('st-mode-selector');
    const dateFilterGroup = document.getElementById('st-date-filter-group');
    const dateFilterSelect = document.getElementById('st-date-filter');
    const toneSelect = document.getElementById('st-tone-select');
    const reactionSelect = document.getElementById('st-reaction-select');
    const lengthSelector = document.getElementById('st-length-selector');
    const generateBtn = document.getElementById('st-generate-btn');
    const resultsContainer = document.getElementById('st-results-container');
    const initialState = document.getElementById('st-initial-state');
    const loader = document.getElementById('st-loader');
    const generatedTextEl = document.getElementById('st-generated-text');
    const copyBtn = document.getElementById('st-copy-btn');

    // --- State ---
    let currentMode = 'chisme'; // Default to the new mode
    let currentLength = 'media';

    // --- Functions ---
    const getToneInstruction = (toneKey) => {
        const toneMap = {
            'sarcastic_humorous': 'un tono humor√≠stico y sarc√°stico',
            'polemic_opinative': 'un tono pol√©mico y opinativo',
            'ironic_critical': 'un tono ir√≥nico y cr√≠tico',
            'emotional_reflective': 'un tono emocional y reflexivo',
            'curious_emotional': 'un tono curioso que despierte intriga y termine con una conexi√≥n emocional',
            'inspiring_critical': 'un tono inspirador pero a la vez cr√≠tico y directo',
            'sarcastic_polemic': 'un tono sarc√°stico y provocador',
            'double_meaning_humor': 'un tono con humor de doble sentido',
            'curious_polemic': 'un tono que empiece con curiosidad y termine en pol√©mica',
            'dramatic_emotional': 'un tono dram√°tico y muy emocional',
            'pure_sarcastic': 'un tono puramente sarc√°stico',
            'pure_polemic': 'un tono puramente pol√©mico',
            'pure_humorous': 'un tono puramente humor√≠stico',
            'pure_ironic': 'un tono puramente ir√≥nico',
            'pure_curious': 'un tono puramente curioso y de intriga',
            'pure_emotional': 'un tono puramente emocional y sentimental',
            'pure_critical': 'un tono puramente cr√≠tico y directo',
            'pure_motivational': 'un tono puramente motivacional',
            'pure_double_meaning': 'un tono puramente de doble sentido',
            'pure_dramatic': 'un tono puramente dram√°tico'
        };
        return toneMap[toneKey] || 'un tono neutro e informativo';
    };

    const getLengthInstruction = (lengthKey) => {
        const lengthMap = {
            'corta': 'corta',
            'media': 'de longitud media',
            'larga': 'extensa y detallada'
        };
        return lengthMap[lengthKey] || 'de longitud media';
    };

    const toggleLoading = (isLoading) => {
        loader.classList.toggle('hidden', !isLoading);
        generateBtn.disabled = isLoading;
    };

    const generateStory = async () => {
        const ai = getAiInstance();
        if (!ai) {
             alert('Por favor, introduce tu clave API para usar esta funci√≥n.');
             return;
        }

        toggleLoading(true);
        initialState.style.display = 'none';
        resultsContainer.classList.add('hidden');

        let finalPrompt;
        let config = {};
        const reaction = reactionSelect.options[reactionSelect.selectedIndex].text; // Get the visible text for clarity
        const reactionValue = reactionSelect.value;
        const tone = getToneInstruction(toneSelect.value);
        const length = getLengthInstruction(currentLength);
        const topic = topicInput.value.trim();

        if (currentMode === 'chisme') {
            const topicInstruction = topic 
                ? `La confesi√≥n debe girar en torno al siguiente tema: "${topic}".`
                : "Si no se proporciona un tema, inventa uno relacionado con situaciones cotidianas y relaciones personales (familia, amigos, pareja, trabajo).";

             let structureInstruction;
            if (reactionValue.includes('empat√≠a') || reactionValue.includes('reflexi√≥n')) {
                structureInstruction = "Crea una historia de **Dilema/Desahogo** como los ejemplos de referencia. Debe ser un relato personal detallado sobre una situaci√≥n dif√≠cil, terminando con una reflexi√≥n emocional, una sensaci√≥n de estar atrapado o simplemente como un desahogo para ventilar una situaci√≥n.";
            } else if (reactionValue.includes('debate') || reactionValue.includes('comentarios')) {
                structureInstruction = "Crea una historia de **\"Qu√© Hago\"** como el ejemplo de la jefa. Debe presentar un dilema moral o social y terminar con una pregunta directa a la audiencia.";
            } else { // Risa, suspense, etc.
                structureInstruction = "Crea una historia con un **Giro Inesperado** como el ejemplo de los hermanos. Debe tener un final sorprendente, gracioso o impactante.";
            }

            finalPrompt = `Act√∫a como un experto en crear contenido viral de "chismes" y "confesiones an√≥nimas" para redes sociales. Tu misi√≥n es escribir una historia ${length} en formato de confesi√≥n, inspir√°ndote en los siguientes ejemplos para capturar el tono y la estructura perfectos.

**EJEMPLOS DE REFERENCIA (NO COPIAR, SOLO APRENDER EL ESTILO):**

*   **Ejemplo 1 - Giro Inesperado (Objetivo: Risa/Sorpresa):**
    > üö®Confesi√≥n An√≥nima üö®
    > Haz de cuenta que somos 5 hermanos y un d√≠a que nos juntamos una de mis hermanas le reviso el celular a mi pap√°... encontr√≥ mensajes muy fuertes con otra mujer... Fuimos a decirle a mi mam√° enfrente de mi papa para que no lo negara... y resulta que esos mensajes eran de mi mam√°, ellos ten√≠an esas din√°micas para poner picor en su relaci√≥n... todos los hermanos quedamos espantados y se nos quitaron las ganas de ser chismosos jajaja

*   **Ejemplo 2 - Dilema/Desahogo (Objetivo: Empat√≠a/Reflexi√≥n):**
    > An√≥nimo por favor!
    > Resulta que ten√≠a a√±os viendo cosas que me hac√≠an dudar de mi esposo, pero estaba sumergida en preocupaciones y tristeza por mi hijo que tiene autismo... me enter√© de que andaba coqueteando con una compa√±era de su trabajo... Estoy en una situaci√≥n muy dif√≠cil porque... mi hijo ya ha pasado por 5 escuelas y en la que esta ahora se ha adaptado mejor... A veces es muy obvio lo que se tiene que hacer pero cuando uno se encuentra inmerso en la situaci√≥n todo se siente m√°s pesado üò•

*   **Ejemplo 3 - Desahogo Personal (Objetivo: Empat√≠a/Desahogo):**
    > üö®Confesi√≥n An√≥nimaüö®
    > Hace un tiempo mi ex me termino, fue muy fr√≠a la manera en que lo hizo... esa √∫ltima vez que lo vi fue hace un tiempesito, recuerdo haberme quedado sola en esa banca llorando mientras el se iba... El ya me hab√≠a sido infiel en 2 ocasiones pero yo por amor siempre lo perdone... Ahora, una de las √∫ltimas citas que tuve con el... me di cuenta que tenia piojitos, yo por amor no le di importancia... pero, cuando me termino... record√© lo de los piojitos y pues en ese momento estaba una con el coraz√≥n rot√≥ en recuperaci√≥n y piojosa üò≠. Espero el no lea esto jaja, y si lo lee lo siento, necesitaba desahogarme üòÆ‚Äçüí®

*   **Ejemplo 4 - "Qu√© Hago" (Objetivo: Debate/Comentarios):**
    > üö®Confesi√≥n An√≥nimaüö®
    > La hermana de mi jefa le anda agarrando dinero de la caja del negocio, me di cuenta por pura casualidad porque la vi. No he querido decir nada porque la jefa siempre dice que su hermana es su mano derecha... pero la neta anda de u√±a. Creen que vale la pena decir algo, o le sigo el rollo?

**TU TAREA AHORA:**
Crea una confesi√≥n COMPLETAMENTE NUEVA Y ORIGINAL siguiendo los par√°metros y reglas a continuaci√≥n.

**Par√°metros de Contenido:**
- **Tema:** ${topicInstruction}
- **Tono:** La narrativa debe tener ${tone}.
- **Objetivo y Estructura:** El objetivo principal es "${reaction}". Para lograrlo, ${structureInstruction}
- **Longitud:** La historia debe ser ${length}.

**Reglas de Formato y Estilo (OBLIGATORIAS):**
1.  **Encabezado:** Var√≠a el inicio. Puedes usar "üö®Confesi√≥n An√≥nima üö®", "An√≥nimo por favor!" o empezar directamente la historia sin ning√∫n encabezado para que se sienta m√°s natural.
2.  **Lenguaje:** Usa un lenguaje 100% conversacional, coloquial y natural, como si alguien le estuviera contando un chisme a un amigo. Utiliza el espa√±ol que se habla com√∫nmente en M√©xico. Evita a toda costa un vocabulario formal o rebuscado.
3.  **Emojis:** Usa emojis de forma sutil y natural para acentuar emociones, como en los ejemplos.
4.  **Detalles Personales:** Incluye detalles peque√±os, espec√≠ficos y a veces un poco vergonzosos (como lo de los 'piojitos' en el ejemplo). Estos detalles hacen que la historia se sienta mucho m√°s real y aut√©ntica.

El resultado final debe ser √∫nicamente el texto de la historia, sin explicaciones adicionales.`;

        } else if (currentMode === 'inventada') {
            const nicheInstruction = topic 
                ? `El contenido ser√° para el nicho "${topic}".`
                : "Como no se especific√≥ un tema, elige t√∫ uno que sea emocional, humano y cercano a un p√∫blico de 20 a 45 a√±os (ejemplos: superar un miedo, la importancia de la amistad, una an√©cdota de viaje inesperada).";

            finalPrompt = `Act√∫a como un equipo experto en storytelling, marketing, neuromarketing, copywriting y psicolog√≠a emocional.
Crea una historia ${length} y viral con estructura narrativa (inicio impactante, desarrollo emocional y cierre reflexivo o con giro).

${nicheInstruction}
El tono de la historia ser√° ${tone},
y su objetivo ser√° ${reactionSelect.value}.

**Instrucciones de Lenguaje y Estilo (MUY IMPORTANTE):**
- Tu espa√±ol debe ser 100% natural, coloquial y f√°cil de entender, espec√≠ficamente como el que se habla com√∫nmente en M√©xico.
- Evita a toda costa palabras rebuscadas, t√©cnicas o demasiado formales. Usa un vocabulario que cualquiera pueda comprender.
- La narrativa debe ser emocional y cinematogr√°fica, que enganche desde la primera l√≠nea y deje una sensaci√≥n fuerte al final.
- El texto debe ser 100% listo para publicar y apto para monetizaci√≥n.

El resultado debe ser √∫nicamente el texto de la historia, sin t√≠tulos, explicaciones, ni saludos.`;

        } else { // web mode
            if (!topic) {
                alert('Por favor, introduce un tema para la historia en modo "Basada en Web".');
                toggleLoading(false);
                initialState.style.display = 'flex';
                return;
            }
            
            const dateFilterValue = dateFilterSelect.value;
            let dateInstruction = '';
            switch(dateFilterValue) {
                case 'hour': dateInstruction = ' que ocurrieron en la √∫ltima hora'; break;
                case 'today': dateInstruction = ' que ocurrieron hoy (en las √∫ltimas 24 horas)'; break;
                case 'yesterday': dateInstruction = ' que ocurrieron ayer'; break;
                case 'before_yesterday': dateInstruction = ' que ocurrieron antier'; break;
                case 'any': default: dateInstruction = ''; break;
            }

            finalPrompt = `Act√∫a como un creador de contenido experto en curiosidades y datos interesantes para redes sociales. Tu especialidad es encontrar informaci√≥n en la web y transformarla en posts virales, entretenidos y f√°ciles de leer. Debes replicar el estilo de los siguientes ejemplos.

**EJEMPLOS DE REFERENCIA (NO COPIAR, SOLO APRENDER EL ESTILO):**

*   **Ejemplo 1 - Hecho Sorprendente:**
    > Curiosidades que con suerte NO sab√≠as. El actor Rowan Atkinson logr√≥ lo que cualquier actor so√±ar√≠a, ya que su personaje de Mr. Bean es mundialmente famoso... ¬øqu√© episodios recuerdas en realidad? Y no ser√≠a dif√≠cil ya que la serie solo tuvo una √∫nica temporada con 15 episodios, pero eran repetidos tantas veces... que parecer√≠an temporadas completas.

*   **Ejemplo 2 - An√©cdota "Detr√°s de C√°maras":**
    > Brad Pitt casi pierde su trabajo por culpa del final de la pel√≠cula? El estudio quiso cambiar el final porque lo consideraba demasiado oscuro... Pero Brad Pitt apost√≥ por ese final y les dijo; "Si cambian el final yo me bajo del proyecto‚Äù. Por suerte dejaron ese final intacto y se convirti√≥ en uno de los m√°s impactantes de la historia del cine. ¬øOs la imagin√°is con un final feliz?

*   **Ejemplo 3 - Lista de Datos:**
    > Datos curiosos que quiz√° no sab√≠as sobre el cine üé¨‚ú®
    > 1Ô∏è‚É£ La primera proyecci√≥n p√∫blica de cine fue en Par√≠s en 1895...
    > 2Ô∏è‚É£ El famoso rugido del le√≥n de MGM fue grabado en 1928...
    > 3Ô∏è‚É£ La primera pel√≠cula a color no fue El mago de Oz, sino Viaje a la Luna (1902)...

**TU TAREA AHORA:**
Crea un post de curiosidades COMPLETAMENTE NUEVO Y ORIGINAL sobre el tema que te dar√©, siguiendo el estilo de los ejemplos y las reglas a continuaci√≥n.

**Proceso Obligatorio:**
1.  **Investigaci√≥n:** Realiza una b√∫squeda en Google sobre "${topic}"${dateInstruction}. Busca datos curiosos, hechos poco conocidos, historias detr√°s de c√°maras, an√©cdotas o estad√≠sticas sorprendentes.
2.  **Creaci√≥n de Contenido:** Basado en lo que encuentres, redacta un post. Puedes usar diferentes formatos seg√∫n lo que se ajuste mejor: un relato de una an√©cdota (como el de Brad Pitt), una lista de datos curiosos (como el de 'Datos curiosos del cine'), o una explicaci√≥n de un hecho sorprendente (como el de Mr. Bean). A veces, puedes terminar con una pregunta para fomentar la interacci√≥n.

**Reglas del Post:**
- **Tono:** La narrativa debe tener ${tone}.
- **Longitud:** El post debe ser de longitud ${length}.
- **Objetivo:** El post debe ${reactionSelect.value}.
- **Idioma y Estilo (CR√çTICO):** Usa un espa√±ol 100% natural, coloquial y conversacional, como el que se habla en M√©xico. El post debe ser entretenido, no un reporte acad√©mico.
- **Formato:** El resultado debe ser √∫nicamente el texto del post, sin t√≠tulos, explicaciones, saludos o listas de fuentes.`;
            config.tools = [{ googleSearch: {} }];
        }
        
        try {
            const response = await ai.models.generateContent({
                model: "gemini-2.5-flash",
                contents: finalPrompt,
                config,
            });

            generatedTextEl.textContent = response.text;
            resultsContainer.classList.remove('hidden');

        } catch (error) {
            console.error('Error al generar la historia:', error);
            alert('Ocurri√≥ un error al generar la historia. Int√©ntalo de nuevo.');
            initialState.style.display = 'flex';
        } finally {
            toggleLoading(false);
        }
    };
    
    // --- Event Listeners ---
    topicInput.addEventListener('input', () => {
        // In web mode, a topic is required. In other modes, it's optional.
        if (currentMode === 'web') {
            generateBtn.disabled = !topicInput.value.trim();
        } else {
            generateBtn.disabled = false;
        }
    });

    modeSelector.addEventListener('click', (e) => {
        const button = e.target.closest('button');
        if (button && button.dataset.mode) {
            currentMode = button.dataset.mode;
            modeSelector.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            // Show/hide date filter based on mode
            dateFilterGroup.classList.toggle('hidden', currentMode !== 'web');

            // Re-evaluate button disabled state when mode changes
            if (currentMode === 'web') {
                generateBtn.disabled = !topicInput.value.trim();
                topicInput.labels[0].textContent = "Tema de la Historia";
                topicInput.placeholder = "Ej: Pel√≠cula 'Seven', Mr. Bean...";
            } else {
                generateBtn.disabled = false;
                 topicInput.labels[0].textContent = "Tema de la Historia (o dejar en blanco)";
                 topicInput.placeholder = "Ej: Superar un miedo (opcional)...";
            }
        }
    });

    lengthSelector.addEventListener('click', (e) => {
        const button = e.target.closest('button');
        if (button && button.dataset.length) {
            currentLength = button.dataset.length;
            lengthSelector.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
        }
    });

    generateBtn.addEventListener('click', generateStory);
    
    copyBtn.addEventListener('click', () => {
        if (!generatedTextEl.textContent) return;
        navigator.clipboard.writeText(generatedTextEl.textContent).then(() => {
            const originalContent = copyBtn.innerHTML;
            copyBtn.textContent = '¬°Copiado!';
            copyBtn.classList.add('copied');
            
            setTimeout(() => {
                copyBtn.innerHTML = originalContent;
                copyBtn.classList.remove('copied');
            }, 2000);
        }).catch(err => {
            console.error('Error al copiar texto: ', err);
            alert('No se pudo copiar el texto.');
        });
    });

    // Initial State Setup
    generateBtn.disabled = false; // Enabled by default for "inventada" and "chisme" modes
};
